---
title: "3_AlphaDiversity_and_DataTransformations"
output: html_document
date: "2023-04-26"
---
```{r Libraries}
library(phyloseq)
library(microbiome)
library(tidyverse)
library(ggpubr)
library(rstatix)
library(data.table)
library(knitr)
library(grid)
library(gridExtra)
```

#Saving processed phyloseq objects
```{r rarefaction}
ps_1 <- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_1.Rds")
otu_ok <- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/otu_ok.Rds")
# keep result reproductive
 set.seed(111)
 ps.rarefied = rarefy_even_depth(ps_1, rngseed=1, replace=F)
 ps.rarefied

```

```{r Counts}
reads_per_sample <- as.matrix(rowSums(t(otu_ok)))
reads_per_sample_after_raref <- as.matrix(rowSums(t(as.matrix(otu_table(ps.rarefied)))))
```

```{r Clean}
 # Remove samples with less than MINREADS from phyloseq object
ps_2 <- prune_taxa(taxa_sums(ps_1) > 0, ps_1)
# merge all taxa that are detected rare
total_samples <- phyloseq::nsamples(ps_2)
ps_2
saveRDS(ps_2, "~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_2.Rds")

 # Remove samples with less than MINREADS from phyloseq object
ps.rarefied.clean <- prune_taxa(taxa_sums(ps.rarefied) > 1, ps.rarefied)
# merge all taxa that are detected rare
total_samples2 <- phyloseq::nsamples(ps.rarefied.clean)
ps.rarefied.clean

ps_2_genus <- tax_glom(ps_2, taxrank = 'Genus', NArm = FALSE)
ps_raref_genus <- tax_glom(ps.rarefied.clean, taxrank = 'Genus', NArm = FALSE)
```

#Trees
```{r random tress}
myTaxa = names(sort(taxa_sums(ps_2), decreasing = TRUE)[1:100])
ex1 = prune_taxa(myTaxa, ps_2)
plot(phy_tree(ex1), show.node.label = FALSE)
plot_tree(ex1, color = "Group", label.tips = "Phylum", ladderize = "left", justify = "left" , size = "Abundance")
```


#Number of taxa per group
```{r descriptive analysis}
ps_1 <- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_1.Rds")
ps_1
ps_2 <- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_2.Rds")
ps_2
ps.ctr<-ps_2 %>% subset_samples(Group %in% c("ctr"))
ps.ctr<-prune_taxa(taxa_sums(ps.ctr) > 0, ps.ctr)
ps.ctr
ps.ctrrif<-ps_2 %>% subset_samples(Group %in% c("ctr+rif"))
ps.ctrrif<-prune_taxa(taxa_sums(ps.ctrrif) > 0, ps.ctrrif)
ps.ctrrif
ps.ccl4<-ps_2 %>% subset_samples(Group %in% c("ccl4"))
ps.ccl4<-prune_taxa(taxa_sums(ps.ccl4) > 0, ps.ccl4)
ps.ccl4
ps.ccl4rif<-ps_2 %>% subset_samples(Group %in% c("ccl4+rif"))
ps.ccl4rif<-prune_taxa(taxa_sums(ps.ccl4rif) > 0, ps.ccl4rif)
ps.ccl4rif
```

#Dominant taxa
```{r descriptive analysis 2}
library(repmod)
#Phylum level
ps_2 <- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_2.Rds")
ps.rel<-ps_2 %>% microbiome::transform("compositional") %>% tax_glom(taxrank = 'Phylum', NArm = FALSE) 
# generate a vector containing the full taxonomy path for all OTUs
wholetax <- do.call(paste, c(as.data.frame(tax_table(ps.rel))
                             [c("Kingdom", "Phylum")], 
                             sep = "__"))  # to distinguish from "_" within tax ranks

# turn the otu_table into a data.frame
otu_export <- as.data.frame(t(otu_table(ps.rel)))
tmp <- names(otu_export)

# paste wholetax and OTU_ids together
for(i in 1:length(tmp)){
    names(tmp)[i] = paste(wholetax[i], tmp[i], sep = "__")
}
# overwrite old names
names(otu_export) <- names(tmp)
otu_export<-t(otu_export)
View(as.data.frame(rowSums(otu_export)))
otu_export1<-as.data.frame(rowSums(otu_export))
make_csv_table(otu_export1, "~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/Tables/Dominant_phyla", info = "Dominant_phyla")

#Family level
ps_2 <- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_2.Rds")
ps.rel2<-ps_2 %>% microbiome::transform("compositional") %>% tax_glom(taxrank = 'Family', NArm = FALSE)
# generate a vector containing the full taxonomy path for all OTUs
wholetax <- do.call(paste, c(as.data.frame(tax_table(ps.rel2))
                             [c("Kingdom", "Phylum", "Class", "Order", "Family")], 
                             sep = "__"))  # to distinguish from "_" within tax ranks

# turn the otu_table into a data.frame
otu_export.fam <- as.data.frame(t(otu_table(ps.rel2)))
tmp <- names(otu_export.fam)

# paste wholetax and OTU_ids together
for(i in 1:length(tmp)){
    names(tmp)[i] = paste(wholetax[i], tmp[i], sep = "__")
}
# overwrite old names
names(otu_export.fam) <- names(tmp)
otu_export.fam<-t(otu_export.fam)
View(as.data.frame(rowSums(otu_export.fam)))
otu_export2<-as.data.frame(rowSums(otu_export.fam))
make_csv_table(otu_export2, "~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/Tables/Dominant_families", info = "Dominant_fam")
```




It is important to not use filtered data because many richness estimates are modeled on singletons and doubletons in the occurrence table. So, you need to leave them in the dataset if you want a meaningful estimate.
Moreover, we usually not using normalized data because we want to assess the diversity on the raw data and we are not comparing samples to each other but only assessing diversity within each sample.

I have tested with and without rarefaction and filtering the zeros and without and the differences stay consisent.

#Alpha Diversity 
###Alpha Diversity plots
```{r AlphaDiversity plots}
ps_2 <- readRDS("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ps_2.Rds")
newSTorder = c("ctr", "ctr+rif", "ccl4", "ccl4+rif")


Chao1<-phyloseq::estimate_richness(ps_2, measures = "Chao1")
metadata<- data.frame(sample_data(ps_2)) 
Chao1$Group<-metadata$Group
pChao1 <-ggplot(Chao1, aes(x=Group, y=Chao1))+
  geom_violin(aes(color = Group), trim = FALSE) +  
  geom_boxplot(width = 0.2) +
  theme_classic() + theme(strip.background = element_blank(), axis.text.x.bottom = element_text(angle = -90), axis.text.x = element_text(size = 16), axis.title.y = element_text(size = 16))  +
  geom_pwc(label = "{p.format}{p.signif}", hide.ns = "p.adj") 
#Re-arranging the order of the figure, controls first
pChao1$data$Group <- as.character(pChao1$data$Group)
pChao1$data$Group <- factor(pChao1$data$Group, levels=newSTorder)
pChao1


Shannon<-phyloseq::estimate_richness(ps_2, measures = "shannon")
metadata<- data.frame(sample_data(ps_2)) 
Shannon$Group<-metadata$Group
pShannon <-ggplot(Shannon, aes(x=Group, y=Shannon))+
  geom_violin(aes(color = Group), trim = FALSE) +  
  geom_boxplot(width = 0.2) +
  theme_classic() + theme(strip.background = element_blank(), axis.text.x.bottom = element_text(angle = -90), axis.text.x = element_text(size = 16), axis.title.y = element_text(size = 16))  +
  geom_pwc(label = "{p.format}{p.signif}", hide.ns = "p.adj") 
#Re-arranging the order of the figure, controls first
pShannon$data$Group <- as.character(pShannon$data$Group)
pShannon$data$Group <- factor(pShannon$data$Group, levels=newSTorder)
pShannon

Fisher<-phyloseq::estimate_richness(ps_2, measures = "fisher")
metadata<- data.frame(sample_data(ps_2)) 
Fisher$Group<-metadata$Group
pFisher <-ggplot(Fisher, aes(x=Group, y=Fisher))+
  geom_violin(aes(color = Group), trim = FALSE) +  
  geom_boxplot(width = 0.2) +
  theme_classic() + theme(strip.background = element_blank(), axis.text.x.bottom = element_text(angle = -90), axis.text.x = element_text(size = 16), axis.title.y = element_text(size = 16))  +
  geom_pwc(label = "{p.format}{p.signif}", hide.ns = "p.adj") 
#Re-arranging the order of the figure, controls first
pFisher$data$Group <- as.character(pFisher$data$Group)
pFisher$data$Group <- factor(pFisher$data$Group, levels=newSTorder)
pFisher

ggarrange(pShannon, pChao1, pFisher,common.legend = TRUE, legend="bottom",nrow = 1)

all_ASVs_boxplots <- ggarrange(pShannon, pChao1, pFisher,common.legend = TRUE, legend="bottom",nrow = 1)

# Modify the legend order in the updated plot
all_ASVs_boxplots <- ggsave(filename = "~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/Figures/AphaDIV_all_genus_boxplots.pdf", width = 12, height = 8)
```

###Alpha Diversity statistical tests (check)
```{r Alpha Diversity statistical tests}
## pairwise test with Wilcoxon rank-sum test, corrected by FDR method.
rich = estimate_richness(ps_2, measures = c("Observed", "Chao1","Shannon", "Fisher"))
wilcox.observed <- pairwise.wilcox.test(rich$Observed, 
                                        sample_data(ps_2)$Group, 
                                        p.adjust.method = "BH")
wilcox.observed

tab.observed <- wilcox.observed$p.value %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "group1") %>%
  gather(key="group2", value="p.adj", -group1) %>%
  na.omit()
tab.observed

#Lo mismo pero usando el índice de Shannon
wilcox.shannon <- pairwise.wilcox.test(rich$Shannon, 
                                       sample_data(ps_2)$Group, 
                                       p.adjust.method = "BH")
wilcox.shannon 
tab.shannon <- wilcox.shannon$p.value %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "group1") %>%
  gather(key="group2", value="p.adj", -group1) %>%
  na.omit()
tab.shannon

#Lo mismo pero usando el índice Chao1
wilcox.chao <- pairwise.wilcox.test(rich$Chao1, 
                                    sample_data(ps_2)$Group, 
                                    p.adjust.method = "BH")
wilcox.chao 
tab.chao <- wilcox.chao$p.value %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "group1") %>%
  gather(key="group2", value="p.adj", -group1) %>%
  na.omit()
tab.chao

#Lo mismo pero usando el índice Fisher
wilcox.fisher <- pairwise.wilcox.test(rich$Fisher, 
                                      sample_data(ps_2)$Group, 
                                      p.adjust.method = "BH")
wilcox.fisher 
tab.fisher <- wilcox.fisher$p.value %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "group1") %>%
  gather(key="group2", value="p.adj", -group1) %>%
  na.omit()
tab.fisher
```
