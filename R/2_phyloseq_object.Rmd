---
title: "2_phyloseq_object"
output: html_document
---

```{r phyloseq}
library(phyloseq); packageVersion("phyloseq")
library(ggplot2); packageVersion("ggplot2")
library(readr)
library(readxl)

library(readr)
tax_table <- read_csv("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/Tables/tax_table.csv")
asvmat <- read_csv("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/Tables/otu_table.csv")
otu_ok <- subset(asvmat, select = -c(CV1_S1, CV16_S2, CR23_S3, CR24_S4, CC34_36_S5, CC37_1_S6, CCR55_S7, CCR56_S8))

metadata <- read_excel("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/metadata.xlsx")
tree<- readRDS("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/phylo_tree.rds")
dna<- readDNAStringSet("~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ASV.fasta")

tax_table$Species<- ifelse(is.na(tax_table$Species...7) == TRUE, tax_table$Species...8, ifelse(is.na(tax_table$Species...7) == FALSE, tax_table$Species...7, "NA"))
tax_table <- subset(tax_table, select = -c(Species...7, Species...8))

 OTU = otu_table(otu_ok, taxa_are_rows = TRUE)
 TAX = tax_table(as.matrix(tax_table))
 SAMPLE = sample_data(metadata)
 TREE = read_tree(tree)
 
rownames(SAMPLE) <-metadata$SampleID

 ps_1 <- phyloseq(OTU, TAX, SAMPLE, TREE)
 ps_1
saveRDS(ps_1, "~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/ps_1.Rds")  
saveRDS(otu_ok, "~/Documents/Lola/CIPF_2018/Rats_HE_CCL4model/output/otu_ok.Rds")  

#Rarefaction curve
S <- specnumber(t(otu_ok)) # observed number of species
(raremax <- min(rowSums(t(otu_ok))))
Srare <- rarefy(t(otu_ok), raremax)
plot(S, Srare, xlab = "Observed No. of Species", ylab = "Rarefied No. of Species")
abline(0, 1)
rarecurve(t(otu_ok), step = 20, sample = raremax, col = "black", cex = 0.6)
```

