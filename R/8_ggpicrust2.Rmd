---
title: "8_ggpicrust2"
output: html_document
date: "2023-05-10"
---

Differential abundance(DA) analysis plays a major role in PICRUSt2 downstream analysis. pathway_daa() integrates almost all DA methods applicable to the predicted functional profile which there excludes ANCOM and ANCOMBC. It includes ALDEx2(Fernandes et al., 2013), DEseq2(Love et al., 2014), Maaslin2(Mallick et al., 2021), LinDA(Zhou et al., 2022), edgeR(Robinson et al., 2010) , limma voom(Ritchie et al., 2015), metagenomeSeq(Paulson et al., 2013), lefser(Segata et al., 2011).
#Using LinDA
```{r setup, include=FALSE}
#If you want to analyze kegg pathway abundance instead of ko within the pathway. You should turn ko_to_kegg to TRUE.
#The kegg pathway typically have the more explainable description.
#metadata should be tibble.
library(readr)
library(ggpicrust2)
library(tibble)
library(tidyverse)
library(ggprism)
library(patchwork)
library(readxl)
metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

group <- "Group"

kegg_abundance <-
  ko2kegg_abundance(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

saveRDS(kegg_abundance, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/kegg_abundance.Rds")

daa_results_df_LinDA <-
  pathway_daa(
    abundance = kegg_abundance,
    metadata = metadata,
    group = group,
    daa_method = "LinDA",
    select = NULL,
    reference = "ctr"
  )

daa_sub_method_results_df_LinDA <-
  daa_results_df_LinDA[daa_results_df_LinDA$method == "LinDA", ]

daa_annotated_sub_method_results_df_LinDA <-
  pathway_annotation(pathway = "KO",
                     daa_results_df = daa_sub_method_results_df_LinDA,
                     ko_to_kegg = TRUE)

saveRDS(daa_results_df_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_results_df_LinDA.Rds")
saveRDS(daa_sub_method_results_df_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_sub_method_results_df_LinDA.Rds")
saveRDS(daa_annotated_sub_method_results_df_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_annotated_sub_method_results_df_LinDA.Rds")


Group <-
  metadata$Type # column which you are interested in metadata

daa_results_list_LinDA <-
  pathway_errorbar(
    abundance = kegg_abundance,
    daa_results_df = daa_annotated_sub_method_results_df_LinDA,
    Group = Group,
    p_values_threshold = 0.05,
    order = "pathway_class",
    select = NULL,
    ko_to_kegg = TRUE,
    p_value_bar = TRUE,
    colors = NULL,
    x_lab = "pathway_name"
  )

saveRDS(daa_results_list_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_results_list_LinDA.Rds")

heatmap_plot <- ggpicrust2::pathway_heatmap(t(kegg_abundance), metadata, "Type")
metadata<- as_tibble(metadata)
pca_plot <- ggpicrust2::pathway_pca((kegg_abundance), metadata, "Type")
print(pca_plot)
```

#Using ALDEx2
```{r ALDEx2}
#If you want to analyze kegg pathway abundance instead of ko within the pathway. You should turn ko_to_kegg to TRUE.
#The kegg pathway typically have the more explainable description.
#metadata should be tibble.
library(readr)
library(ggpicrust2)
library(tibble)
library(tidyverse)
library(ggprism)
library(patchwork)
library(readxl)
metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

group <- "Group"

kegg_abundance <-
  ko2kegg_abundance(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

daa_results_df_ALDEx2 <-
  pathway_daa(
    abundance = kegg_abundance,
    metadata = metadata,
    group = group,
    daa_method = "ALDEx2",
    select = NULL,
    reference = NULL
  )

daa_sub_method_results_df_ALDEx2 <-
  daa_results_df_ALDEx2[daa_results_df_ALDEx2$method == "ALDEx2_Kruskal-Wallace test", ]

daa_annotated_sub_method_results_df_ALDEx2 <-
  pathway_annotation(pathway = "KO",
                     daa_results_df = daa_sub_method_results_df_ALDEx2,
                     ko_to_kegg = TRUE)

saveRDS(daa_results_df_ALDEx2, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_results_df_ALDEx2.Rds")
saveRDS(daa_sub_method_results_df_ALDEx2, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_sub_method_results_df_ALDEx2.Rds")
saveRDS(daa_annotated_sub_method_results_df_ALDEx2, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_annotated_sub_method_results_df_ALDEx2.Rds")


Group <-
  metadata$Type # column which you are interested in metadata

daa_results_list_ALDEx2 <-
  pathway_errorbar(
    abundance = kegg_abundance,
    daa_results_df = daa_annotated_sub_method_results_df_LinDA,
    Group = Group,
    p_values_threshold = 0.05,
    order = "pathway_class",
    select = NULL,
    ko_to_kegg = TRUE,
    p_value_bar = TRUE,
    colors = NULL,
    x_lab = "pathway_name"
  )
```

#Using limma voom
```{r limma voom}
#If you want to analyze kegg pathway abundance instead of ko within the pathway. You should turn ko_to_kegg to TRUE.
#The kegg pathway typically have the more explainable description.
#metadata should be tibble.
library(readr)
library(ggpicrust2)
library(tibble)
library(tidyverse)
library(ggprism)
library(patchwork)
library(readxl)
metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

group <- "Group"

kegg_abundance <-
  ko2kegg_abundance(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

daa_results_df_limma <-
  pathway_daa(
    abundance = kegg_abundance,
    metadata = metadata,
    group = group,
    daa_method = "limma voom",
    select = NULL,
    reference = "ctr"
  )

daa_annotated_sub_method_results_df_LinDA <-
  pathway_annotation(pathway = "KO",
                     daa_results_df = daa_results_df_limma,
                     ko_to_kegg = TRUE)
```

daa_results_df_DESeq2<-
    pathway_daa(
        abundance = kegg_abundance,
        metadata = metadata,
        group = group,
        daa_method = "DESeq2",
        select = NULL,
        reference = "ctr"
    )

daa_annotated_sub_method_results_df_DESeq2 <-
    pathway_annotation(pathway = "KO",
                       daa_results_df = daa_results_df_DESeq2,
                       ko_to_kegg = TRUE)