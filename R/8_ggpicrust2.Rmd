---
title: "8_ggpicrust2"
output: html_document
date: "2023-05-10"
---

Differential abundance(DA) analysis plays a major role in PICRUSt2 downstream analysis. pathway_daa() integrates almost all DA methods applicable to the predicted functional profile which there excludes ANCOM and ANCOMBC. It includes ALDEx2(Fernandes et al., 2013), DEseq2(Love et al., 2014), Maaslin2(Mallick et al., 2021), LinDA(Zhou et al., 2022), edgeR(Robinson et al., 2010) , limma voom(Ritchie et al., 2015), metagenomeSeq(Paulson et al., 2013), lefser(Segata et al., 2011).
#Pathways differential abundance
###Using LinDA
```{r setup, include=FALSE}
#If you want to analyze kegg pathway abundance instead of ko within the pathway. You should turn ko_to_kegg to TRUE.
#The kegg pathway typically have the more explainable description.
#metadata should be tibble.
library(readr)
library(ggpicrust2)
library(tibble)
library(tidyverse)
library(ggprism)
library(patchwork)
library(readxl)
metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

group <- "Group"

kegg_abundance <-
  ko2kegg_abundance(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

saveRDS(kegg_abundance, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/kegg_abundance.Rds")

daa_results_df_LinDA <-
  pathway_daa(
    abundance = kegg_abundance,
    metadata = metadata,
    group = group,
    daa_method = "LinDA",
    select = NULL,
    reference = "ctr"
  )

daa_sub_method_results_df_LinDA <-
  daa_results_df_LinDA[daa_results_df_LinDA$method == "LinDA", ]

daa_annotated_sub_method_results_df_LinDA <-
  pathway_annotation(pathway = "KO",
                     daa_results_df = daa_sub_method_results_df_LinDA,
                     ko_to_kegg = TRUE)

saveRDS(daa_results_df_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_results_df_LinDA.Rds")
saveRDS(daa_sub_method_results_df_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_sub_method_results_df_LinDA.Rds")
saveRDS(daa_annotated_sub_method_results_df_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_annotated_sub_method_results_df_LinDA.Rds")


Group <-
  metadata$Type # column which you are interested in metadata

daa_results_list_LinDA <-
  pathway_errorbar(
    abundance = kegg_abundance,
    daa_results_df = daa_annotated_sub_method_results_df_LinDA,
    Group = Group,
    p_values_threshold = 0.05,
    order = "pathway_class",
    select = NULL,
    ko_to_kegg = TRUE,
    p_value_bar = TRUE,
    colors = NULL,
    x_lab = "pathway_name"
  )

saveRDS(daa_results_list_LinDA, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_results_list_LinDA.Rds")

heatmap_plot <- ggpicrust2::pathway_heatmap(t(kegg_abundance), metadata, "Type")
metadata<- as_tibble(metadata)
pca_plot <- ggpicrust2::pathway_pca((kegg_abundance), metadata, "Type")
print(pca_plot)
```

###Using ALDEx2
```{r ALDEx2}
#If you want to analyze kegg pathway abundance instead of ko within the pathway. You should turn ko_to_kegg to TRUE.
#The kegg pathway typically have the more explainable description.
#metadata should be tibble.
library(readr)
library(ggpicrust2)
library(tibble)
library(tidyverse)
library(ggprism)
library(patchwork)
library(readxl)
metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

group <- "Group"

kegg_abundance <-
  ko2kegg_abundance(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

daa_results_df_ALDEx2 <-
  pathway_daa(
    abundance = kegg_abundance,
    metadata = metadata,
    group = group,
    daa_method = "ALDEx2",
    select = NULL,
    reference = NULL
  )

daa_sub_method_results_df_ALDEx2 <-
  daa_results_df_ALDEx2[daa_results_df_ALDEx2$method == "ALDEx2_Kruskal-Wallace test", ]

daa_annotated_sub_method_results_df_ALDEx2 <-
  pathway_annotation(pathway = "KO",
                     daa_results_df = daa_sub_method_results_df_ALDEx2,
                     ko_to_kegg = TRUE)

saveRDS(daa_results_df_ALDEx2, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_results_df_ALDEx2.Rds")
saveRDS(daa_sub_method_results_df_ALDEx2, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_sub_method_results_df_ALDEx2.Rds")
saveRDS(daa_annotated_sub_method_results_df_ALDEx2, "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/ggpicrust2/daa_annotated_sub_method_results_df_ALDEx2.Rds")


Group <-
  metadata$Type # column which you are interested in metadata

daa_results_list_ALDEx2 <-
  pathway_errorbar(
    abundance = kegg_abundance,
    daa_results_df = daa_annotated_sub_method_results_df_LinDA,
    Group = Group,
    p_values_threshold = 0.05,
    order = "pathway_class",
    select = NULL,
    ko_to_kegg = TRUE,
    p_value_bar = TRUE,
    colors = NULL,
    x_lab = "pathway_name"
  )
```

###Using limma voom
```{r limma voom}
#If you want to analyze kegg pathway abundance instead of ko within the pathway. You should turn ko_to_kegg to TRUE.
#The kegg pathway typically have the more explainable description.
#metadata should be tibble.
library(readr)
library(ggpicrust2)
library(tibble)
library(tidyverse)
library(ggprism)
library(patchwork)
library(readxl)
metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

group <- "Group"

kegg_abundance <-
  ko2kegg_abundance(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

daa_results_df_limma <-
  pathway_daa(
    abundance = kegg_abundance,
    metadata = metadata,
    group = group,
    daa_method = "limma voom",
    select = NULL,
    reference = "ctr"
  )

daa_annotated_sub_method_results_df_LinDA <-
  pathway_annotation(pathway = "KO",
                     daa_results_df = daa_results_df_limma,
                     ko_to_kegg = TRUE)
```


#KO differential abundance
```{r KO abundance}
ko_abundance <-
  read_tsv(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/pred_metagenome_unstrat.tsv")

ko_abundance<-data.frame(ko_abundance)
rownames(ko_abundance)<- ko_abundance$function.
ko_abundance<-subset(ko_abundance, select = -c(function.))
ko_abundance<-ko_abundance[!rowSums(ko_abundance == 0) >= 3, , drop = FALSE]

metadata <- read_excel("~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/metadata.xlsx")
metadata<-as.data.frame(metadata)
rownames(metadata)<-metadata$SampleID
metadata<-as.data.frame(metadata)
View(metadata)

methods <- c("ALDEx2", "DESeq2", "LinDA")
daa_results_list <- lapply(methods, function(method) {
  pathway_daa(abundance = ko_abundance, metadata = metadata, group = "Group", daa_method = method, p.adjust = "BH", reference = "ccl4")
})
methods <- c( "LinDA", "limma voom", "metagenomeSeq")
daa_results_list2 <- lapply(methods, function(method) {
    pathway_daa(abundance = ko_abundance, metadata = metadata, group = "Group", daa_method = method, p.adjust = "BH", reference = "ccl4")
})
saveRDS(daa_results_list, file = "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/output/daa_results_list_ko_abundance_Al_DES_Lin")

# Compare results across different methods
comparison_results <- ggpicrust2::compare_daa_results(daa_results_list = daa_results_list, method_names = c("	
ALDEx2_glm test", "ALDEx2_Kruskal-Wallace test", "DESeq2", "LinDA"))
comparison_results2 <- ggpicrust2::compare_daa_results(daa_results_list = daa_results_list, method_names = c( "LinDA", "limma voom", "metagenomeSeq"))

results_ALDEx2<- daa_results_list[[1]] %>% data.frame()  %>% filter(p_adjust< 0.05) %>% subset(select = c(feature, method, group1, group2, group3, group4, p_values, p_adjust)) %>% unite("features_comparisons", c(feature, group1, group2, group3, group4)) %>% rename(p_adjust_ALDEx2 =p_adjust, p_value_ALDEx2 =p_values)

results_DESeq2<- daa_results_list[[2]] %>% data.frame()  %>% filter(p_adjust< 0.05)%>% subset(select = c(feature, method, group1, group2, p_values, p_adjust))%>% 
    mutate(group1 = factor(group1, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")), 
           group2 = factor(group2, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif"))) %>% unite("features_comparisons", c(feature, group1, group2))  %>% rename(p_adjust_DESeq2 =p_adjust, p_value_DESeq2 =p_values)

results_LinDA<- daa_results_list2[[1]]%>% data.frame()  %>% filter(p_adjust< 0.05)%>% subset(select = c(feature, method, group1, group2, p_values, p_adjust))%>% 
    mutate(group1 = factor(group1, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")), 
           group2 = factor(group2, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")))%>% unite("features_comparisons", c(feature, group2, group1)) %>% rename(p_adjust_LinDA =p_adjust, p_value_LinDA =p_values)

results_limma_voom<- daa_results_list2[[2]]%>% data.frame()  %>% filter(p_adjust< 0.05)%>% subset(select = c(feature, method, group1, group2, p_values, p_adjust))%>% 
    mutate(group1 = factor(group1, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")), 
           group2 = factor(group2, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")))%>% unite("features_comparisons", c(feature, group1, group2))%>% rename(p_adjust_limma_voom =p_adjust, p_value_limma_voom =p_values)

results_metagenomeSeq<- daa_results_list2[[3]]%>% data.frame() %>% filter(p_values< 0.05)%>% subset(select = c(feature, method, group1, group2, p_values, p_adjust))%>% 
    mutate(group1 = factor(group1, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")), 
           group2 = factor(group2, 
                          levels=c("ctr", "ctr+rif", "ccl4", "ccl4+rif")))%>% unite("features_comparisons", c(feature, group1, group2)) %>% rename(p_adjust_metagenomeSeq =p_adjust, p_value_metagenomeSeq =p_values)

comparison_results <- results_metagenomeSeq%>%
    full_join(results_ALDEx2, by="features_comparisons")%>%
    full_join(results_DESeq2, by="features_comparisons")%>%
    full_join(results_LinDA, by="features_comparisons")%>%
    full_join(results_limma_voom, by="features_comparisons")%>% unite("methods", c(method,method.x, method.y, method.x.x, method.y.y)) 

```


#EC differential abundance
```{r EC abundance}
metacyc_abundance <-
  read_tsv(
    "~/Library/CloudStorage/OneDrive-UniversitatdeValencia/Doctorado/Estudios/CIPF_Estudio1_2018/Rats_HE_CCL4model/input/EC_metagenome_out/pred_metagenome_unstrat.tsv")
methods <- c("ALDEx2", "DESeq2", "LinDA")
daa_results_list <- lapply(methods, function(method) {
  pathway_daa(abundance = metacyc_abundance %>% column_to_rownames("pathway"), metadata = metadata, group = "Group", daa_method = method, p.adjust = "BH", reference = "ccl4")
})

method_names <- c("ALDEx2_Welch's t test","ALDEx2_Wilcoxon rank test","DESeq2", "LinDA")
# Compare results across different methods
comparison_results <- compare_daa_results(daa_results_list = daa_results_list, method_names = method_names)
